<?xml version="1.1" encoding="UTF-8" standalone="no"?>
<databaseChangeLog xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
                   xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
                   xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-3.5.xsd">
    <changeSet author="vnechiporenko" id="autogenerated-ids" context="schemedata">
        <createSequence sequenceName="serial"/>
    </changeSet>
    <changeSet author="vnechiporenko" id="1484663393384-2" context="schemedata">
        <createTable tableName="authorities">
            <column name="username" type="VARCHAR(50)">
                <constraints nullable="false"/>
            </column>
            <column name="authority" type="VARCHAR(50)">
                <constraints nullable="false"/>
            </column>
        </createTable>
    </changeSet>
    <changeSet author="vnechiporenko" id="1484663393384-3" context="schemedata">
        <createTable tableName="entities">
            <column name="entity_id" type="INT">
                <constraints nullable="false"/>
            </column>
            <column name="type_of_entity" type="INT"/>
            <column name="parent_id" type="INT"/>
        </createTable>
    </changeSet>
    <changeSet author="vnechiporenko" id="1484663393384-4" context="schemedata">
        <createTable tableName="entity_attributes">
            <column name="type_of_entity_id" type="INT">
                <constraints nullable="false"/>
            </column>
            <column name="attribute_id" type="INT">
                <constraints nullable="false"/>
            </column>
        </createTable>
    </changeSet>
    <changeSet author="vnechiporenko" id="1484663393384-5" context="schemedata">
        <createTable tableName="relationship">
            <column name="entity_id" type="INT">
                <constraints nullable="false"/>
            </column>
            <column name="entity_val" type="INT">
                <constraints nullable="false"/>
            </column>
            <column name="attribute_id" type="INT">
                <constraints nullable="false"/>
            </column>
        </createTable>
    </changeSet>
    <changeSet author="vnechiporenko" id="1484663393384-6" context="schemedata">
        <createTable tableName="types_attributes">
            <column name="attribute_id" type="INT">
                <constraints nullable="false"/>
            </column>
            <column name="name" type="VARCHAR(255)"/>
            <column name="type_of_attribute" type="INT"/>
        </createTable>
    </changeSet>
    <changeSet author="vnechiporenko" id="1484663393384-7" context="schemedata">
        <createTable tableName="types_of_entities">
            <column name="type_of_entity_id" type="INT">
                <constraints nullable="false"/>
            </column>
            <column name="name" type="VARCHAR(255)"/>
        </createTable>
    </changeSet>
    <changeSet author="vnechiporenko" id="1484663393384-8" context="schemedata">
        <createTable tableName="userconnection">
            <column name="userid" type="VARCHAR(255)">
                <constraints nullable="false"/>
            </column>
            <column name="providerid" type="VARCHAR(255)">
                <constraints nullable="false"/>
            </column>
            <column name="provideruserid" type="VARCHAR(255)">
                <constraints nullable="false"/>
            </column>
            <column name="rank" type="INT">
                <constraints nullable="false"/>
            </column>
            <column name="displayname" type="VARCHAR(255)"/>
            <column name="profileurl" type="VARCHAR(512)"/>
            <column name="imageurl" type="VARCHAR(512)"/>
            <column name="accesstoken" type="VARCHAR(1024)">
                <constraints nullable="false"/>
            </column>
            <column name="secret" type="VARCHAR(255)"/>
            <column name="refreshtoken" type="VARCHAR(255)"/>
            <column name="expiretime" type="BIGINT"/>
        </createTable>
    </changeSet>
    <changeSet author="vnechiporenko" id="1484663393384-9" context="schemedata">
        <createTable tableName="userprofile">
            <column name="userid" type="VARCHAR(255)">
                <constraints nullable="false"/>
            </column>
            <column name="email" type="VARCHAR(255)"/>
            <column name="firstname" type="VARCHAR(255)"/>
            <column name="lastname" type="VARCHAR(255)"/>
            <column name="city" type="VARCHAR(255)"/>
            <column name="name" type="VARCHAR(255)"/>
            <column name="username" type="VARCHAR(255)"/>
            <column name="userentityid" type="INT"/>
        </createTable>
    </changeSet>
    <changeSet author="vnechiporenko" id="1484663393384-10" context="schemedata">
        <createTable tableName="users">
            <column name="username" type="VARCHAR(50)">
                <constraints nullable="false"/>
            </column>
            <column name="password" type="VARCHAR(50)">
                <constraints nullable="false"/>
            </column>
            <column name="enabled" type="BOOLEAN">
                <constraints nullable="false"/>
            </column>
        </createTable>
    </changeSet>
    <changeSet author="vnechiporenko" id="1484663393384-11" context="schemedata">
        <createTable tableName="values">
            <column name="attribute_id" type="INT">
                <constraints nullable="false"/>
            </column>
            <column name="entity_id" type="INT">
                <constraints nullable="false"/>
            </column>
            <column name="date_value" type="TIMESTAMP(6) WITHOUT TIME ZONE"/>
            <column name="int_value" type="INT"/>
            <column name="text_value" type="VARCHAR(255)"/>
        </createTable>
    </changeSet>
    <changeSet author="vnechiporenko" id="1484663393384-12" context="schemedata">
        <addPrimaryKey columnNames="entity_id" constraintName="entities_pkey" tableName="entities"/>
    </changeSet>
    <changeSet author="vnechiporenko" id="1484663393384-13" context="schemedata">
        <addPrimaryKey columnNames="entity_id, entity_val, attribute_id" constraintName="relationship_pkey" tableName="relationship"/>
    </changeSet>
    <changeSet author="vnechiporenko" id="1484663393384-14" context="schemedata">
        <addPrimaryKey columnNames="attribute_id" constraintName="types_attributes_pkey" tableName="types_attributes"/>
    </changeSet>
    <changeSet author="vnechiporenko" id="1484663393384-15" context="schemedata">
        <addPrimaryKey columnNames="type_of_entity_id" constraintName="types_of_entities_pkey" tableName="types_of_entities"/>
    </changeSet>
    <changeSet author="vnechiporenko" id="1484663393384-16" context="schemedata">
        <addPrimaryKey columnNames="userid, providerid, provideruserid" constraintName="userconnection_pkey" tableName="userconnection"/>
    </changeSet>
    <changeSet author="vnechiporenko" id="1484663393384-17" context="schemedata">
        <addPrimaryKey columnNames="userid" constraintName="userprofile_pkey" tableName="userprofile"/>
    </changeSet>
    <changeSet author="vnechiporenko" id="1484663393384-18" context="schemedata">
        <addPrimaryKey columnNames="username" constraintName="users_pkey" tableName="users"/>
    </changeSet>
    <changeSet author="vnechiporenko" id="1484663393384-19" context="schemedata">
        <addPrimaryKey columnNames="attribute_id, entity_id" constraintName="values_pkey" tableName="values"/>
    </changeSet>
    <changeSet author="vnechiporenko" id="1484663393384-20" context="schemedata">
        <addUniqueConstraint columnNames="type_of_entity_id, attribute_id" constraintName="uk_rs4q91b7jl33pkh10a1ybgpm3" tableName="entity_attributes"/>
    </changeSet>
    <changeSet author="vnechiporenko" id="1484663393384-21" context="schemedata">
        <createIndex indexName="ix_auth_username" tableName="authorities" unique="true">
            <column name="username"/>
            <column name="authority"/>
        </createIndex>
    </changeSet>
    <changeSet author="vnechiporenko" id="1484663393384-22" context="schemedata">
        <createIndex indexName="userconnectionrank" tableName="userconnection" unique="true">
            <column name="userid"/>
            <column name="providerid"/>
            <column name="rank"/>
        </createIndex>
    </changeSet>
    <changeSet author="vnechiporenko" id="1484663393384-23" context="schemedata">
        <addForeignKeyConstraint baseColumnNames="attribute_id" baseTableName="entity_attributes" constraintName="fk_1c1yur5nqaq2qgamrk3qpaviq" deferrable="false" initiallyDeferred="false" onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="attribute_id" referencedTableName="types_attributes"/>
    </changeSet>
    <changeSet author="vnechiporenko" id="1484663393384-24" context="schemedata">
        <addForeignKeyConstraint baseColumnNames="entity_id" baseTableName="relationship" constraintName="fk_1mujrn3bp408pujeeg4skmwaw" deferrable="false" initiallyDeferred="false" onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="entity_id" referencedTableName="entities"/>
    </changeSet>
    <changeSet author="vnechiporenko" id="1484663393384-25" context="schemedata">
        <addForeignKeyConstraint baseColumnNames="parent_id" baseTableName="entities" constraintName="fk_2f7wt9plqgav1h2bu3vprtodb" deferrable="false" initiallyDeferred="false" onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="entity_id" referencedTableName="entities"/>
    </changeSet>
    <changeSet author="vnechiporenko" id="1484663393384-26" context="schemedata">
        <addForeignKeyConstraint baseColumnNames="entity_val" baseTableName="relationship" constraintName="fk_7ml7ux1mvkqa295fvh26epds1" deferrable="false" initiallyDeferred="false" onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="entity_id" referencedTableName="entities"/>
    </changeSet>
    <changeSet author="vnechiporenko" id="1484663393384-27" context="schemedata">
        <addForeignKeyConstraint baseColumnNames="username" baseTableName="authorities" constraintName="fk_authorities_users" deferrable="false" initiallyDeferred="false" onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="username" referencedTableName="users"/>
    </changeSet>
    <changeSet author="vnechiporenko" id="1484663393384-28" context="schemedata">
        <addForeignKeyConstraint baseColumnNames="type_of_entity_id" baseTableName="entity_attributes" constraintName="fk_kurr0r2uudu6xr7e607q8pedd" deferrable="false" initiallyDeferred="false" onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="type_of_entity_id" referencedTableName="types_of_entities"/>
    </changeSet>
    <changeSet author="vnechiporenko" id="1484663393384-29" context="schemedata">
        <addForeignKeyConstraint baseColumnNames="entity_id" baseTableName="values" constraintName="fk_re5hfjwgt2xf596qgl4tvpdj8" deferrable="false" initiallyDeferred="false" onDelete="CASCADE" onUpdate="NO ACTION" referencedColumnNames="entity_id" referencedTableName="entities"/>
    </changeSet>
    <changeSet author="vnechiporenko" id="1484663393384-30" context="schemedata">
        <addForeignKeyConstraint baseColumnNames="userentityid" baseTableName="userprofile" constraintName="fk_userprofile_entities" deferrable="false" initiallyDeferred="false" onDelete="NO ACTION" onUpdate="NO ACTION" referencedColumnNames="entity_id" referencedTableName="entities"/>
    </changeSet>
</databaseChangeLog>
